version: 2

jobs:
  python2:
    docker:
      - image: circleci/python:2.7
    environment:
      - DEPLOY_PYPI: false
    steps:
      - checkout
      - run: pip install virtualenv && virtualenv ~/venv
      - run: bash ./ci_scripts/circleci/install.sh
      - store_artifacts:
          path: ~/venv
          destination: ~/venv
      - store_artifacts:
          path: doc/_build/
          destination: doc
      - store_artifacts:
          path: ~/log.txt
          destination: log.txt

  python3:
    docker:
      - image: circleci/python:3.5
    environment:
      - DEPLOY_PYPI: true
    steps:
      - checkout
      - run: python -m venv ~/venv
      - run: bash ./ci_scripts/circleci/install.sh
      - store_artifacts:
          path: doc/_build/
          destination: doc
      - store_artifacts:
          path: ~/log.txt
          destination: log.txt
      - store_artifacts:
          path: ~/venv
          destination: ~/venv
      - persist_to_workspace:
          root: doc/_build/
          paths: .

  deploy:
    docker:
      - image: circleci/python:3.5
    environment:
      # The github organization or username of the repository which hosts the
      # project and documentation.
      - USERNAME: ysig

      # The repository where the documentation will be hosted
      - DOC_REPO: GraKeL

      # The base URL for the Github page where the documentation will be hosted
      - DOC_URL: dev

      # The email is to be used for commits in the Github Page
      - EMAIL: y.siglidis@gmail.com

      # Deploy docs on pypi
      - DEPLOY_PYPI: true
    steps:
      - checkout
      - attach_workspace:
          at: doc/_build/
      - run: bash ./ci_scripts/circleci/push_doc.sh
      - run: bash ./ci_scripts/circleci/pypi_deploy.sh

workflows:
  version: 2
  build-doc-and-deploy:
    jobs:
      - python3
      - python2
      - deploy:
          requires:
            - python2
            - python3
          filters:
            branches:
              only: develop

